@model AdvancedTodoLearningCards.ViewModels.ReviewSessionViewModel

@{
    ViewData["Title"] = "Review Session";
}

<div class="container py-4">
    <!-- Progress Bar -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">
                <i class="fas fa-graduation-cap me-2"></i>
                Review Session
            </h5>
            <span class="badge bg-primary">@Model.CurrentIndex / @Model.TotalCards</span>
        </div>
        <div class="progress-custom">
            <div class="progress-bar-custom" id="progressBar" style="width: @Model.Progress%"></div>
        </div>
    </div>

    <!-- Review Card -->
    @if (Model.CurrentCard != null)
    {
        <div class="review-card fade-in" id="reviewCard">
            <div id="questionSide">
                <div class="mb-3">
                    @foreach (var tag in Model.CurrentCard.Tags)
                    {
                        <span class="tag">@tag</span>
                    }
                </div>

                <h2 class="review-question mb-4">
                    @Model.CurrentCard.Title
                </h2>

                <button type="button" class="btn btn-primary-custom btn-lg" id="showAnswerBtn">
                    <i class="fas fa-eye me-2"></i>Show Answer
                </button>
            </div>

            <div id="answerSide" style="display: none;">
                <div class="mb-3">
                    @foreach (var tag in Model.CurrentCard.Tags)
                    {
                        <span class="tag">@tag</span>
                    }
                </div>

                <h3 class="review-question mb-3">
                    @Model.CurrentCard.Title
                </h3>

                <div class="review-answer mb-4">
                    @Model.CurrentCard.Content
                </div>

                <hr class="my-4">

                <h5 class="text-center mb-3">How well did you remember?</h5>
                <div class="quality-buttons">
                    <button type="button" class="btn btn-quality btn-quality-again" data-quality="0">
                        <i class="fas fa-times-circle me-2"></i>Again
                    </button>
                    <button type="button" class="btn btn-quality btn-quality-hard" data-quality="2">
                        <i class="fas fa-frown me-2"></i>Hard
                    </button>
                    <button type="button" class="btn btn-quality btn-quality-good" data-quality="4">
                        <i class="fas fa-smile me-2"></i>Good
                    </button>
                    <button type="button" class="btn btn-quality btn-quality-perfect" data-quality="5">
                        <i class="fas fa-star me-2"></i>Perfect
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
            <h2 class="fw-bold mb-3">Review Session Complete!</h2>
            <p class="lead text-secondary mb-4">Great job! You've reviewed all your due cards.</p>
            <a asp-controller="Dashboard" asp-action="Index" class="btn btn-primary-custom">
                <i class="fas fa-chart-line me-2"></i>View Dashboard
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        let currentCardId = @(Model.CurrentCard?.CardId ?? 0);
        let currentIndex = @Model.CurrentIndex;
        let totalCards = @Model.TotalCards;
        let cards = @Html.Raw(Json.Serialize(Model.Cards));

        // Show Answer
        document.getElementById('showAnswerBtn')?.addEventListener('click', function() {
            document.getElementById('questionSide').style.display = 'none';
            document.getElementById('answerSide').style.display = 'block';
        });

        // Quality Button Click
        document.querySelectorAll('.btn-quality').forEach(btn => {
            btn.addEventListener('click', async function() {
                const quality = parseInt(this.dataset.quality);

                // Disable all buttons
                document.querySelectorAll('.btn-quality').forEach(b => b.disabled = true);

                // Submit review using FormData
                try {
                    const formData = new FormData();
                    formData.append('cardId', currentCardId);
                    formData.append('quality', quality);
                    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');

                    const response = await fetch('@Url.Action("SubmitReview", "Review")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        currentIndex++;

                        if (currentIndex < totalCards) {
                            // Load next card
                            loadNextCard();
                        } else {
                            // Session complete
                            window.location.href = '@Url.Action("Index", "Dashboard")';
                        }
                    } else {
                        alert('Error submitting review: ' + (result.message || 'Unknown error'));
                        document.querySelectorAll('.btn-quality').forEach(b => b.disabled = false);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error submitting review. Please try again.');
                    document.querySelectorAll('.btn-quality').forEach(b => b.disabled = false);
                }
            });
        });

        function loadNextCard() {
            if (currentIndex < cards.length) {
                const nextCard = cards[currentIndex];
                currentCardId = nextCard.cardId;

                // Update progress
                const progress = Math.round((currentIndex / totalCards) * 100);
                document.getElementById('progressBar').style.width = progress + '%';

                // Reset card view
                document.getElementById('questionSide').style.display = 'block';
                document.getElementById('answerSide').style.display = 'none';

                // Update content
                document.querySelector('.review-question').textContent = nextCard.title;
                document.querySelector('.review-answer').textContent = nextCard.content;

                // Re-enable buttons
                document.querySelectorAll('.btn-quality').forEach(b => b.disabled = false);

                // Fade in animation
                document.getElementById('reviewCard').classList.remove('fade-in');
                setTimeout(() => {
                    document.getElementById('reviewCard').classList.add('fade-in');
                }, 10);
            }
        }
    </script>
    @Html.AntiForgeryToken()
}